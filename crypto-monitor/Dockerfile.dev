# Development Dockerfile with hot-reload support
FROM rust:1.82-bookworm

# Install dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    cmake \
    protobuf-compiler \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install development tools
RUN cargo install cargo-watch && \
    cargo install sqlx-cli --version 0.7.4 --no-default-features --features postgres

# Create app directory
WORKDIR /app

# Copy workspace files
COPY Cargo.toml ./
COPY monitor-core/Cargo.toml ./monitor-core/
COPY monitor-anomaly/Cargo.toml ./monitor-anomaly/
COPY monitor-api/Cargo.toml ./monitor-api/
COPY monitor-notifier/Cargo.toml ./monitor-notifier/
COPY monitor-trader/Cargo.toml ./monitor-trader/
COPY monitor-config/Cargo.toml ./monitor-config/
COPY monitor-app/Cargo.toml ./monitor-app/

# Copy barter dependencies
COPY ../barter ./barter
COPY ../barter-data ./barter-data
COPY ../barter-execution ./barter-execution
COPY ../barter-integration ./barter-integration
COPY ../barter-instrument ./barter-instrument

# Pre-build dependencies
RUN cargo build

# Copy source code
COPY . .

# Expose ports
EXPOSE 8080 8081

# Set environment variables
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1

# Run with cargo-watch for hot reload
CMD ["cargo", "watch", "-x", "run", "--", "--config", "/app/config/config.yaml"]